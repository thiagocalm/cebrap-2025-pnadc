---
title: "Pesquisa Nacional por Amostra de Domicílios Contínua (PNADC)"
subtitle: "Dia 2 - Exercício assíncrono com acumulados dos trimestres"
author: "Thiago Cordeiro Almeida"
institute: "Centre d'Estudis Demogràfics (CED, Espanha) · Cebrap"
date: today
date-format: long
logo: "images/cebrap-imagem.png"
footer: "cebrap.lab - PNADC"

format:
  pdf:
    papersize: a4
    fontsize: 12pt
    geometry: margin=2.5cm
    number-sections: true
    theme: template/cebrap2025.scss
    math: mathjax
    header-includes: |
      \usepackage{fancyhdr}
      \usepackage{graphicx}
      \pagestyle{fancy}
      \fancyhf{}
      % Logo on the left of footer
      \fancyfoot[L]{\includegraphics[height=1cm]{images/cebrap-imagem.png}}
      % Footer text centered
      \fancyfoot[C]{cebrap.lab - PNADC}
      % Page number on the right
      \fancyfoot[R]{\thepage}
      % Remove header content
      \renewcommand{\headrulewidth}{0pt}
      \renewcommand{\footrulewidth}{0pt}
      % Section numbering style
      \renewcommand\thesection{\arabic{section}.}

editor: visual
execute:
  freeze: auto
  echo: true
  warning: false
  message: false
---

```{r, echo=FALSE}
knitr::opts_chunk$set(error=FALSE, warning=FALSE, message=FALSE)
```


# Introdução

Vamos trabalhar com dados dos Trimestres da PNADC para o ano de 2021. A ideia é que trabalhemos com os acumulados dos trimestres e que façamos uma análise de conjuntura de alguns indicadores de mercado de trabalho ao longo do ano de 2021.

```{r}

# ajustes gerais
options(timeout = 1200, scipen = 99999)
invisible(gc())

## pacotes necessarios
# instalando pacotes
ifelse(!require(PNADcIBGE),install.packages("PNADcIBGE"),require(PNADcIBGE))
ifelse(!require(survey),install.packages("survey"),require(survey))

# definicao do diretorio de trabalho
setwd(file.path(here::here(),"dia 2","praticas"))

```

# Importação dos dados

Há duas formas de importação desses dados.

## Baixando os 4 bancos trimestrais de 2021 diretamente do site do IBGE

```{r}

P_21_t1 <- get_pnadc(
  year = 2021,
  quarter = 1,
  design = TRUE,
  vars = c("VD4009", "VD4002"),
  reload = FALSE
)
P_21_t2 <- get_pnadc(
  year = 2021,
  quarter = 2,
  design = TRUE,
  vars = c("VD4009", "VD4002"),
  reload = FALSE
)
P_21_t3 <- get_pnadc(
  year = 2021,
  quarter = 3,
  design = TRUE,
  vars = c("VD4009", "VD4002"),
  reload = FALSE
)
P_21_t4 <- get_pnadc(
  year = 2021,
  quarter = 4,
  design = TRUE,
  vars = c("VD4009", "VD4002"),
  reload = FALSE
)

```

## Diretamente da pasta, com os dados armazenados no computador

Esta é uma boa alternativa para poupar tempo com o download dos dados. Todavia, deve-se ter em conta que tenha em seu computador, na pasta do diretório que está trabalhando, os seguintes arquivos (exemplo para o Trimestre 1 de 2021):

- **microdado**: "PNADC_012021.txt",

- **input_txt**: "input_PNADC_trimestral.txt",

- **dicionario**: "dicionario_PNADC_microdados_trimestral.xls"

```{r, eval=FALSE}
# 2.1 - Primeiro voce deve baixar os microdados, dicionario e input no site do IBGE

# 2.2 - Importar a base

# Trimestre 1
P_21_t1 <- read_pnadc(
  microdata = "PNADC_012021.txt",
  input_txt = "input_PNADC_trimestral.txt"
)

# Trimestre 2
P_21_t2 <- read_pnadc(
  microdata = "PNADC_022021.txt",
  input_txt = "input_PNADC_trimestral.txt"
)

# Trimestre 3
P_21_t3 <- read_pnadc(
  microdata = "PNADC_032021.txt",
  input_txt = "input_PNADC_trimestral.txt"
)

# Trimestre 4
P_21_t4 <- read_pnadc(
  microdata = "PNADC_042021.txt",
  input_txt = "input_PNADC_trimestral.txt"
)

# 2.3 - Atribuindo os labels às bases

# Trimestre 1
P_21_t1 <- pnadc_labeller(
  data_pnadc = P_21_t1,
  dictionary.file = "dicionario_PNADC_microdados_trimestral.xls"
)

# Trimestre 2
P_21_t2 <- pnadc_labeller(
  data_pnadc = P_21_t2,
  dictionary.file = "dicionario_PNADC_microdados_trimestral.xls"
)

# Trimestre 3
P_21_t3 <- pnadc_labeller(
  data_pnadc = P_21_t3,
  dictionary.file = "dicionario_PNADC_microdados_trimestral.xls"
)

# Trimestre 4
P_21_t4 <- pnadc_labeller(
  data_pnadc = P_21_t4,
  dictionary.file = "dicionario_PNADC_microdados_trimestral.xls"
)

# 2.4 - Atribuindo o plano amostral

# Trimestre 1
P_21_t1 <- pnadc_design(P_21_t1)

# Trimestre 2
P_21_t2 <- pnadc_design(P_21_t2)

# Trimestre 3
P_21_t3 <- pnadc_design(P_21_t3)

# Trimestre 4
P_21_t4 <- pnadc_design(P_21_t4)
```

# Análises com PNADC

Após a aplicação do plano amostral ao banco de dados seguindo a função `pnadc_design()`, **no caso de ter utilizado os microdados já baixados e armazenados em seu computador, podemos fazer análises diretamente usando o pacote `{survey}`.

1.  Numero de empregados com carteira assinada

Vamos usar a variável `VD4009`

```{r}
Vinculo_t1 <- svytotal(~VD4009, P_21_t1, na.rm = T)
Vinculo_t2 <- svytotal(~VD4009, P_21_t2, na.rm = T)
Vinculo_t3 <- svytotal(~VD4009, P_21_t3, na.rm = T)
Vinculo_t4 <- svytotal(~VD4009, P_21_t4, na.rm = T)
```

Para se observar os resultados, usamos os códigos abaixo:

```{r}
# Resultados
Vinculo_t1
Vinculo_t2
Vinculo_t3
Vinculo_t4
```

Para salvar os resultados e fazemos o gráfico em excel, podemos usar o código abaixo. Ele salvará os resultados na pasta do diretório de trabalho.

```{r}
# Salvando em csv para abrir no excel e fazer o grafico
write.csv2(Vinculo_t1, "Vinculo_t1.csv")
write.csv2(Vinculo_t2, "Vinculo_t2.csv")
write.csv2(Vinculo_t3, "Vinculo_t3.csv")
write.csv2(Vinculo_t4, "Vinculo_t4.csv")
```


2.  Condição de ocupação das pessoas com 14 anos ou mais

O mesmo processo pode ser feito para a segunda variável, relacionada à condição de ocupação das pessoas com 14 anos ou mais na semana de referência.

Primeiro geramos as estimativas usando a função `svytotal()`:

```{r}
Condicao_t1 <- svytotal(~VD4002, P_21_t1, na.rm = T)
Condicao_t2 <- svytotal(~VD4002, P_21_t2, na.rm = T)
Condicao_t3 <- svytotal(~VD4002, P_21_t3, na.rm = T)
Condicao_t4 <- svytotal(~VD4002, P_21_t4, na.rm = T)
```

Podemos observar os resultados printando eles:

```{r}
# Resultados
Condicao_t1
Condicao_t2
Condicao_t3
Condicao_t4
```

Caso queiramos observar os intervalos de confiança para termos noção sobre qual a amplitude da incerteza em que eu posso dizer sobre as diferenças que estou observando, posso rodar o código abaixo:

```{r}
# Intervalo de confianca dos resultados
confint(Condicao_t1)
confint(Condicao_t2)
confint(Condicao_t3)
confint(Condicao_t4)
```


Podemos exportar os resultados para trabalharmos em excel:

```{r}
# Salvando em csv para abrir no excel e fazer o grafico
write.csv2(Condicao_t1, "Vinculo_t1.csv")
write.csv2(Condicao_t2, "Vinculo_t2.csv")
write.csv2(Condicao_t3, "Vinculo_t3.csv")
write.csv2(Condicao_t4, "Vinculo_t4.csv")
```

# Extra! - gráfico em R

Você pode facilmente utilizar as tabelas que exportamos e fazer gráficos em excel, por exemplo. Todavia, podemos já utilizar da facilidade do R e poder programar um código para o gráfico e, sempre que quisermos, só atualizamos os dados e rodamos o mesmo código.

Vamos fazer este exemplo para as estimativas de tipos de vínculos.

Para isso, vamos usar o pacote ggplot2 e uma gramatica que se chama 'tidyverse' (o 'ggplot2' ja se encontra dentro dessa gramatica 'tidyverse').

```{r}
# importando pacote do tidyverse com o ggplot2 já incorporado
ifelse(!require(tidyverse),install.packages("tidyverse"),require(tidyverse))
```

## Algumas manipulações para fazermos o grafico

Há algumas manipulações que devemos fazer para que nosso gráfico saia esteticamente do jeito que esperamos. O código abaixo vai fazer algumas delas para um gráfico simples.

- Vamos criar um objeto de base de dados com os dados que queremos

- Vamos ajustar os nomes dos tipos de vínculos

- Vamos reestruturar nossa tabela do formato "aberto" para o formato "longo" (mais condizente com o ggplot2)

```{r}
# incluir vinculos em um arquivo data.frame

vinculos <- data.frame(
  tipo_vinculo = names(Vinculo_t1),
  Trim1 = Vinculo_t1[1:10],
  Trim2 = Vinculo_t2[1:10],
  Trim3 = Vinculo_t3[1:10],
  Trim4 = Vinculo_t4[1:10]
)

# excluir nome das linhas

rownames(vinculos) <- NULL

# excluir variavel do tipo_vinculo - queremos excluir a parte "VD4009"

vinculos$tipo_vinculo <- str_replace_all(
  vinculos$tipo_vinculo,
  pattern = "VD4009",
  replacement = ""
)

# fazendo uma pequena manipulacao dos dados para plotar - vamos usar pipes para isso

vinculos <- vinculos |>
  # transformando os trimestres que estavam em colunas para linhas da base
  pivot_longer(
    cols = Trim1:Trim4,
    names_to = "trimestre",
    values_to = "N"
  ) |>
  # atribuindo uma nova classe (factor) para os trimestres
  mutate(
    trimestre = factor(trimestre, levels = c("Trim1","Trim2","Trim3","Trim4"))
  )
```

Agora podemos gerar o nosso gráfico:

```{r,eval=FALSE}
vinculos |>
  ggplot() +
  aes(
    x = trimestre,
    y = N,
    color = tipo_vinculo,
    group = interaction(tipo_vinculo, tipo_vinculo)
  ) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 4) +
  theme_light() +
  labs(
    title = "Tipos de vínculos no acumulado dos trimestres da PNADC - 2021",
    caption = "Fonte: IBGE, PNADC acumulado dos trimestres, 2021.",
    x = "Trimestres",
    y = "Número total de vínculos",
    color = ""
  ) +
  theme(
    legend.position = "bottom"
  )
```

![](graf_tipo_vinculos.png){fig-align="center" width="80%" height="50%"}


Esse gráfico pode passar por uma série de ajustes e modificações, para ficar ainda mais do jeito que gostaríamos.

Caso queira exercitar, pode copiar os códigos que utilizei para a primeira variável (tipo de vínculo) e tentar replicar o gráfico para a segunda variável (condição da ocupação).

